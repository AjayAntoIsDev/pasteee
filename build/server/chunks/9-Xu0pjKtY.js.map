{"version":3,"file":"9-Xu0pjKtY.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/(auth)/register/_page.server.ts.js","../../../.svelte-kit/adapter-node/nodes/9.js"],"sourcesContent":["import { f as fail, r as redirect } from \"../../../../chunks/index.js\";\nimport { p as prisma } from \"../../../../chunks/prisma.js\";\nimport { h as hashPassword } from \"../../../../chunks/crypto.js\";\nimport { nanoid } from \"nanoid\";\nimport { p as public_env, d as private_env } from \"../../../../chunks/shared-server.js\";\nimport { b as generateVerificationHash } from \"../../../../chunks/auth.js\";\nimport { s as sendEmail } from \"../../../../chunks/base.js\";\nimport { v as validateEmail, a as validatePassword, b as validateName, c as validateUsername } from \"../../../../chunks/validate.js\";\nconst sendVerificationEmail = async (userId) => {\n  const user = await prisma.user.findUnique({ where: { id: userId } });\n  if (!user)\n    return false;\n  const hash = await generateVerificationHash(userId);\n  const verifyUrl = `${public_env.PUBLIC_URL}/validate?hash=${encodeURIComponent(\n    hash\n  )}&userId=${encodeURIComponent(userId)}`;\n  const content = `To verify your email, please click the following link: ${verifyUrl}`;\n  const subject = \"YABin: Verify your email\";\n  const sent = await sendEmail(user.email, subject, content);\n  if (!sent)\n    return false;\n  return true;\n};\nconst actions = {\n  default: async ({ cookies, request }) => {\n    if (public_env.PUBLIC_REGISTRATION_ENABLED !== \"true\") {\n      return fail(404, { success: false, errors: [\"Not found\"] });\n    }\n    const data = await request.formData();\n    const name = data.get(\"name\");\n    const username = data.get(\"username\");\n    const email = data.get(\"email\");\n    const password = data.get(\"password\");\n    const cnfPassword = data.get(\"confirm-password\");\n    const errors = [];\n    if (!name || !username || !email || !password || !cnfPassword) {\n      errors.push(\"All fields are required\");\n    }\n    try {\n      if (email)\n        validateEmail(email);\n    } catch (e) {\n      errors.push(e.message);\n    }\n    try {\n      if (password)\n        validatePassword(password);\n    } catch (e) {\n      errors.push(e.message);\n    }\n    try {\n      if (name)\n        validateName(name);\n    } catch (e) {\n      errors.push(e.message);\n    }\n    try {\n      if (username)\n        validateUsername(username);\n    } catch (e) {\n      errors.push(e.message);\n    }\n    if (password && password !== cnfPassword) {\n      errors.push(\"Passwords do not match\");\n    }\n    if (username && email) {\n      const existingCount = await prisma.user.count({\n        where: {\n          OR: [\n            { username: username.toString() },\n            { email: email.toString() }\n          ]\n        }\n      });\n      if (existingCount > 0) {\n        errors.push(\"Username or email already exists\");\n      }\n    }\n    if (errors.length > 0) {\n      return fail(400, { success: false, errors });\n    }\n    if (name && username && email && password) {\n      const user = await prisma.user.create({\n        data: {\n          name: name.toString(),\n          username: username.toString(),\n          email: email.toString(),\n          password: await hashPassword(password.toString(), private_env.SALT),\n          verified: false\n        }\n      });\n      if (private_env.MAIL_ENABLED === \"true\") {\n        const sentVerificationEmail = await sendVerificationEmail(\n          user.id\n        );\n        if (sentVerificationEmail) {\n          return {\n            success: true,\n            message: \"Please check your e-mail for verification link\"\n          };\n        }\n      }\n      await prisma.user.update({\n        where: { id: user.id },\n        data: { verified: true }\n      });\n      const authToken = await prisma.authToken.create({\n        data: {\n          user: {\n            connect: {\n              id: user.id\n            }\n          },\n          createdAt: /* @__PURE__ */ new Date(),\n          expiresAt: new Date(Date.now() + 1e3 * 60 * 60 * 24 * 30),\n          // 30 days\n          token: nanoid(32)\n        }\n      });\n      cookies.set(\"token\", authToken.token, {\n        path: \"/\",\n        maxAge: 60 * 60 * 24 * 30,\n        // 30 days\n        secure: true,\n        httpOnly: true,\n        sameSite: \"strict\"\n      });\n      redirect(303, \"/\");\n    }\n    return { success: false, errors: [\"Unknown error\"] };\n  }\n};\nexport {\n  actions\n};\n","import * as server from '../entries/pages/(auth)/register/_page.server.ts.js';\n\nexport const index = 9;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/(auth)/register/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/(auth)/register/+page.server.ts\";\nexport const imports = [\"_app/immutable/nodes/9.DiYs6I3x.js\",\"_app/immutable/chunks/scheduler.VK6vfmC_.js\",\"_app/immutable/chunks/each.D6YF6ztN.js\",\"_app/immutable/chunks/index.BycGP4sO.js\",\"_app/immutable/chunks/forms.YqOt3IOs.js\",\"_app/immutable/chunks/entry.BtI8Upk3.js\",\"_app/immutable/chunks/public.CIJs8PrL.js\"];\nexport const stylesheets = [];\nexport const fonts = [];\n"],"names":[],"mappings":"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"}