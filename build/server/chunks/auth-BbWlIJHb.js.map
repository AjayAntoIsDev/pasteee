{"version":3,"file":"auth-BbWlIJHb.js","sources":["../../../.svelte-kit/adapter-node/chunks/auth.js"],"sourcesContent":["import { d as private_env } from \"./shared-server.js\";\nimport { h as hashPassword } from \"./crypto.js\";\nimport { p as prisma } from \"./prisma.js\";\nimport { nanoid } from \"nanoid\";\nconst getUserIdFromCookie = async (cookies) => {\n  const token = cookies.get(\"token\");\n  if (!token)\n    return null;\n  const authToken = await prisma.authToken.findFirst({\n    where: { token, expiresAt: { gt: /* @__PURE__ */ new Date() } },\n    include: { user: { select: { id: true, verified: true } } }\n  });\n  if (!authToken)\n    return null;\n  if (!authToken.user.verified)\n    return null;\n  return authToken.user.id;\n};\nconst generateVerificationHash = async (userId) => {\n  const user = await prisma.user.findUnique({ where: { id: userId } });\n  if (!user)\n    throw new Error(\"User not found\");\n  const hash = await hashPassword(\n    `${user.email}${user.id}${user.password}${user.verified}`,\n    private_env.SALT\n  );\n  return hash;\n};\nconst validateVerificationHash = async (userId, hash) => {\n  const user = await prisma.user.findUnique({ where: { id: userId } });\n  if (!user)\n    return false;\n  const newHash = await hashPassword(\n    `${user.email}${user.id}${user.password}${user.verified}`,\n    private_env.SALT\n  );\n  if (newHash !== hash)\n    return false;\n  await prisma.user.update({\n    where: { id: userId },\n    data: { verified: true }\n  });\n  return true;\n};\nconst generatePasswordResetToken = async (userId) => {\n  const user = await prisma.user.findUnique({ where: { id: userId } });\n  if (!user)\n    return false;\n  const resetToken = await prisma.resetToken.upsert({\n    where: {\n      userId: user.id\n    },\n    update: {\n      createdAt: /* @__PURE__ */ new Date(),\n      expiresAt: new Date(Date.now() + 1e3 * 60 * 60 * 24 * 30),\n      // 30 days\n      token: nanoid(32)\n    },\n    create: {\n      user: {\n        connect: {\n          id: user.id\n        }\n      },\n      createdAt: /* @__PURE__ */ new Date(),\n      expiresAt: new Date(Date.now() + 1e3 * 60 * 60 * 24 * 30),\n      // 30 days\n      token: nanoid(32)\n    }\n  });\n  return resetToken.token;\n};\nexport {\n  generatePasswordResetToken as a,\n  generateVerificationHash as b,\n  getUserIdFromCookie as g,\n  validateVerificationHash as v\n};\n"],"names":[],"mappings":"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"}