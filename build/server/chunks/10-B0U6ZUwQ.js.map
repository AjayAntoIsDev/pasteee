{"version":3,"file":"10-B0U6ZUwQ.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/(auth)/reset-password/_page.server.ts.js","../../../.svelte-kit/adapter-node/nodes/10.js"],"sourcesContent":["import { e as error, f as fail, r as redirect } from \"../../../../chunks/index.js\";\nimport { p as prisma } from \"../../../../chunks/prisma.js\";\nimport { h as hashPassword } from \"../../../../chunks/crypto.js\";\nimport { d as private_env } from \"../../../../chunks/shared-server.js\";\nimport { a as validatePassword } from \"../../../../chunks/validate.js\";\nconst load = async ({ url }) => {\n  const userId = url.searchParams.get(\"userId\");\n  const token = url.searchParams.get(\"token\");\n  if (!userId || !token) {\n    error(404, \"Not found\");\n  }\n  const user = await prisma.user.findUnique({ where: { id: userId } });\n  const resetToken = await prisma.resetToken.findUnique({\n    where: { token }\n  });\n  if (!user || !resetToken) {\n    error(404, \"Not found\");\n  }\n  if (resetToken.expiresAt <= /* @__PURE__ */ new Date()) {\n    error(404, \"Expired link\");\n  }\n};\nconst actions = {\n  default: async ({ url, request }) => {\n    const userId = url.searchParams.get(\"userId\");\n    if (!userId)\n      error(404, \"Not found\");\n    const user = await prisma.user.findUnique({ where: { id: userId } });\n    if (!user)\n      error(404, \"Not found\");\n    const data = await request.formData();\n    const newPassword = data.get(\"new-password\");\n    const cnfPassword = data.get(\"confirm-password\");\n    const errors = [];\n    if (!newPassword || !cnfPassword) {\n      errors.push(\"All fields are required\");\n    }\n    if (newPassword !== cnfPassword) {\n      errors.push(\"Passwords need to match\");\n    }\n    try {\n      if (newPassword)\n        validatePassword(newPassword);\n    } catch (e) {\n      errors.push(e.message);\n    }\n    if (newPassword) {\n      const oldPasswordHash = user.password;\n      const newPasswordHash = await hashPassword(\n        newPassword.toString(),\n        private_env.SALT\n      );\n      if (oldPasswordHash === newPasswordHash) {\n        errors.push(\"Cannot use existing password\");\n      }\n    }\n    if (errors.length > 0) {\n      return fail(400, { success: false, errors });\n    }\n    if (newPassword && cnfPassword) {\n      const newPasswordHash = await hashPassword(\n        newPassword.toString(),\n        private_env.SALT\n      );\n      await prisma.user.update({\n        where: { id: userId },\n        data: { password: newPasswordHash }\n      });\n      await prisma.resetToken.delete({ where: { userId } });\n      redirect(303, \"/login\");\n    }\n    return { success: false, errors: [\"Unknown error\"] };\n  }\n};\nexport {\n  actions,\n  load\n};\n","import * as server from '../entries/pages/(auth)/reset-password/_page.server.ts.js';\n\nexport const index = 10;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/(auth)/reset-password/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/(auth)/reset-password/+page.server.ts\";\nexport const imports = [\"_app/immutable/nodes/10.nD2Zca0y.js\",\"_app/immutable/chunks/scheduler.VK6vfmC_.js\",\"_app/immutable/chunks/each.D6YF6ztN.js\",\"_app/immutable/chunks/index.BycGP4sO.js\",\"_app/immutable/chunks/forms.YqOt3IOs.js\",\"_app/immutable/chunks/entry.BtI8Upk3.js\"];\nexport const stylesheets = [];\nexport const fonts = [];\n"],"names":[],"mappings":"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"}